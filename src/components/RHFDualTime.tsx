import { TimeInput, TimeInputProps, TimeInputValue } from "@heroui/react";
import React, { useEffect, useMemo } from "react";
import { Controller, RegisterOptions, useFormContext, useWatch } from "react-hook-form";

interface RHFTimeProps extends Omit<TimeInputProps, "value" | "errorMessage" | "isInvalid"> {
  rules?: RegisterOptions;
  name: string;
}

interface RHFDualTimeProps {
  startTime: RHFTimeProps;
  endTime: RHFTimeProps;
}

const RHFDualTime = ({ startTime, endTime }: RHFDualTimeProps) => {
  const { control, trigger, getValues, formState } = useFormContext<{ [key: string]: TimeInputValue | null }>();

  const startName = useMemo(() => startTime.name, [startTime.name])
  const endName = useMemo(() => endTime.name, [endTime.name])

  const initTime = useWatch({ control, name: [startName] })
  const finishTime = useWatch({ control, name: [endName] })


  useEffect(() => {
    if (!formState.isSubmitted) return
    const values = getValues();

    if (values[startName] && values[endName]) {
      trigger([startName]);
      trigger([endName])
    }
  }, [finishTime, initTime, trigger, getValues, formState.isSubmitted, endName, startName])

  return (
    <>
      <Controller
        control={control}
        name={startName}
        rules={startTime.rules}
        defaultValue={startTime.defaultValue ?? null}
        render={({ field, formState: { errors } }) => (
          <TimeInput
            {...startTime}
            {...field}
            value={field.value}
            isInvalid={Boolean(errors[startName])}
            errorMessage={errors[startName] ? errors[startName]?.message : ""}
          />
        )}
      />
      <Controller
        control={control}
        name={endName}
        rules={endTime.rules}
        defaultValue={endTime.defaultValue ?? null}
        render={({ field, formState: { errors } }) => (
          <TimeInput
            {...endTime}
            {...field}
            value={field.value}
            isInvalid={Boolean(errors[endName])}
            errorMessage={errors[endName] ? errors[endName]?.message : ""}
          />
        )}
      />
    </>
  )
}

export default RHFDualTime